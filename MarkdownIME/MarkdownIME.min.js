var MarkdownIME;(function(e){var t;(function(e){var t;(function(e){var t;(function(e){e.list=/^(UL|OL)$/i;e.li=/^LI$/i;e.cell=/^T[HD]$/i;e.line=/^(P|DIV|H\d|T[HD])$/i;e.blockquote=/^BLOCKQUOTE$/i;e.pre=/^PRE$/i;e.hr=/^HR$/i;e.autoClose=/^(area|base|br|col|command|embed|hr|img|input|keygen|link|meta|param|source|track|wbr)$/i})(t=e.NodeName||(e.NodeName={}))})(t=e.Pattern||(e.Pattern={}));function n(e){var t=e.ownerDocument.defaultView.getSelection();var n=e.ownerDocument.createRange();var r=e;while(r.nodeType==1){var i=r.childNodes;var o=i[i.length-1];if(!o)break;r=o}n.selectNodeContents(r);n.collapse(r.nodeName=="BR");t.removeAllRanges();t.addRange(n)}e.move_cursor_to_end=n;function r(e,t){if(t===void 0){t=true}if(!e)return false;return e.nodeType==Node.TEXT_NODE&&/^[\s\r\n]*$/.test(e.nodeValue)||e.nodeType==Node.COMMENT_NODE||t&&e.nodeName=="BR"}e.is_node_empty=r;function i(e){return!r(e)}e.is_node_not_empty=i;function o(e){if(!e)return false;if(e.nodeType!=1)return false;return t.NodeName.line.test(e.nodeName)||t.NodeName.li.test(e.nodeName)||t.NodeName.pre.test(e.nodeName)}e.is_node_block=o;function a(e){var t=d(e);var n=t.length;if(n==1&&t[0].nodeType==1){return a(t[0])}while(n--){var r=t[n];if(r.nodeType==Node.TEXT_NODE)continue;return false}return true}e.is_line_container_clean=a;function s(e){if(e.textContent.length!=0)return false;if(e.innerHTML.indexOf("<img ")>=0)return false;return true}e.is_line_empty=s;function l(e,t){var n=e.previousSibling;if(!n||n.nodeName!=t){n=e.ownerDocument.createElement(t);e.parentNode.insertBefore(n,e)}return n}e.get_or_create_prev_block=l;function d(e){return[].filter.call(e.childNodes,i)}e.get_real_children=d;function u(e,t){var n=[];var r;r=e.previousSibling;return n}e.get_line_nodes=u;function c(e,t){var n=[];var r=e;while(true){r=r.parentNode;if(!r)break;n.push(r);if(r==t)break}return n}e.build_parent_list=c;function h(e){return e.replace(/&/g,"&amp;").replace(/  /g," &nbsp;").replace(/"/g,"&quot;").replace(/\</g,"&lt;").replace(/\>/g,"&gt;")}e.text2html=h;function p(e){return e.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")}e.text2regex=p;function f(e){var t={nbsp:String.fromCharCode(160),amp:"&",quot:'"',lt:"<",gt:">"};return e.replace(/&(nbsp|amp|quot|lt|gt);/g,function(e,n){return t[n]})}e.html_entity_decode=f;function m(e){return e.replace(/^[\t\r\n ]+/,"").replace(/[\t\r\n ]+$/,"").replace(/[\t\r\n ]+/," ")}e.trim=m;function v(e,t){t.parentNode.replaceChild(e,t);e.appendChild(t)}e.wrap=v;function g(e,n,r){var i="<"+e;if(n){for(var o in n){if(!n.hasOwnProperty(o))continue;var a=""+n[o];a=a.replace(/&/g,"&amp;");a=a.replace(/"/g,"&quot;");a=a.replace(/</g,"&lt;");a=a.replace(/\t/g,"&#x9;");a=a.replace(/\r/g,"&#xA;");a=a.replace(/\n/g,"&#xD;");i+=" "+o+'="'+a+'"'}}i+=">";if(r){i+=r+"</"+e+">"}else if(!t.NodeName.autoClose.test(e)){i+="</"+e+">"}return i}e.generateElementHTML=g})(t=e.Utils||(e.Utils={}))})(MarkdownIME||(MarkdownIME={}));var MarkdownIME;(function(e){var t=function(){function t(){this.text="";this.proxyStorage={};this.markCount=0;this.markPrefix=String.fromCharCode(65532,65529);this.markSuffix=String.fromCharCode(65531)}t.prototype.cloneNode=function(e){var t=e.innerHTML;this.setHTML(t)};t.prototype.digestHTML=function(t){var n=this.createProxy.bind(this);t=t.replace(/<\/?\w+(\s+[^>]*)?>/g,n);t=t.replace(/<!--protect-->.*?<--\/protect-->/g,n);t=t.replace(/<!--.+?-->/g,n);t=e.Utils.html_entity_decode(t);return t};t.prototype.setHTML=function(e){this.markCount=0;this.proxyStorage={};e=this.digestHTML(e);this.text=e};t.prototype.getHTML=function(t){var n=this;var r=t||e.Utils.text2html(this.text);r=r.replace(/\uFFFC\uFFF9\w+\uFFFB/g,function(e){return n.proxyStorage[e]});return r};t.prototype.replace=function(e,t){var n=this;this.text=this.text.replace(e,function(){var e;if(typeof t==="function"){e=t.apply(null,arguments)}else{e=t}return n.digestHTML(e)})};t.prototype.screwUp=function(e,t,n){var r=this;var i={};var o={};this.text=this.text.replace(/\uFFFC\uFFF9\w+\uFFFB/g,function(a){if(i.hasOwnProperty(a))return i[a];if(o.hasOwnProperty(a))return a;var s=r.proxyStorage[a];var l=s.replace(e,t);if(s===l){o[a]=true;return a}if(n)r.proxyStorage[a]=l;else delete r.proxyStorage[a];i[a]=l;return l})};t.prototype.createProxy=function(e){var t;for(t in this.proxyStorage){if(this.proxyStorage[t]===e)return t}t=this.nextMark();this.proxyStorage[t]=e;return t};t.prototype.nextMark=function(){var e;do{this.markCount++;e=this.markPrefix+this.markCount.toString(36)+this.markSuffix}while(this.text.indexOf(e)!==-1);return e};t.prototype.applyTo=function(e){var t=e.ownerDocument.createElement("div");t.innerHTML=this.getHTML();var n=[].slice.call(t.childNodes,0);for(var r=0;r<e.childNodes.length;r++){var i=e.childNodes[r];var o=false;for(var a=0;a<n.length;a++){var s=n[a];o=i.isEqualNode(s);if(o){t.replaceChild(i,s);n.splice(a,1);break}if(s.nodeType==Node.ELEMENT_NODE){for(var l=0;l<s.childNodes.length;l++){var d=s.childNodes[l];if(i.isEqualNode(d)){s.replaceChild(i,d);o=true;break}}}if(o)break}o&&r--}e.innerHTML="";while(t.childNodes.length){e.appendChild(t.firstChild)}};return t}();e.DomChaos=t})(MarkdownIME||(MarkdownIME={}));var MarkdownIME;(function(e){var t;(function(t){var n=function(){function t(t,n,r){this.nodeAttr={};this.nodeName=t.toUpperCase();this.leftBracket=n;this.rightBracket=r||n;this.name=this.nodeName+" with "+this.leftBracket;this.regex=new RegExp("([^\\\\]|^)"+e.Utils.text2regex(this.leftBracket)+"(.*?[^\\\\])"+e.Utils.text2regex(this.rightBracket),"g");this.regex2_L=new RegExp("^<"+this.nodeName+"(\\s+[^>]*)?>$","gi");this.regex2_R=new RegExp("^</"+this.nodeName+">$","gi")}t.prototype.render=function(t){var n=this;t.replace(this.regex,function(t,r,i){if(i===n.rightBracket)return t;return r+e.Utils.generateElementHTML(n.nodeName,n.nodeAttr,e.Utils.text2html(i))})};t.prototype.unrender=function(e){e.screwUp(this.regex2_L,this.leftBracket);e.screwUp(this.regex2_R,this.rightBracket)};return t}();t.InlineWrapperRule=n;var r=function(){function e(e,t,n){this.name=e;this.regex=t;this.replacement=n}e.prototype.render=function(e){e.replace(this.regex,this.replacement)};e.prototype.unrender=function(e){};return e}();t.InlineRegexRule=r;var i=function(){function t(){this.rules=[]}t.prototype.RenderChaos=function(e){e.screwUp(/^<!--escaping-->$/g,"\\");for(var t=0;t<this.rules.length;t++){var n=this.rules[t];if(typeof n.unrender==="function")n.unrender(e)}for(var t=0;t<this.rules.length;t++){var n=this.rules[t];n.render(e)}e.replace(/\\([^\w\s])/g,function(e,t){return"<!--escaping-->"+t})};t.prototype.RenderHTML=function(t){var n=new e.DomChaos;n.setHTML(t);this.RenderChaos(n);return n.getHTML()};t.prototype.RenderText=function(t){return this.RenderHTML(e.Utils.text2html(t))};t.prototype.RenderTextNode=function(e){var t=e.ownerDocument.createElement("div");var n;t.textContent=e.textContent;n=this.RenderNode(t);while(t.lastChild){e.parentNode.insertBefore(t.lastChild,e.nextSibling)}e.parentNode.removeChild(e);return n};t.prototype.RenderNode=function(t){var n=new e.DomChaos;n.cloneNode(t);this.RenderChaos(n);n.applyTo(t);return[].slice.call(t.childNodes,0)};t.prototype.AddMarkdownRules=function(){this.rules=t.markdownReplacement.concat(this.rules);return this};t.prototype.AddRule=function(e){this.rules.push(e)};t.markdownReplacement=[new r("img with title",/\!\[(.*?)\]\(([^\)\s]+)\s+("?)([^\)]+)\3\)/g,function(t,n,r,i,o){return e.Utils.generateElementHTML("img",{alt:n,src:r,title:o})}),new r("img",/\!\[(.*?)\]\(([^\)]+)\)/g,function(t,n,r){return e.Utils.generateElementHTML("img",{alt:n,src:r})}),new r("link with title",/\[(.*?)\]\(([^\)\s]+)\s+("?)([^\)]+)\3\)/g,function(t,n,r,i,o){return e.Utils.generateElementHTML("a",{href:r,title:o},e.Utils.text2html(n))}),new r("link",/\[(.*?)\]\(([^\)]+)\)/g,function(t,n,r){return e.Utils.generateElementHTML("a",{href:r},e.Utils.text2html(n))}),new n("del","~~"),new n("strong","**"),new n("em","*"),new n("code","`")];return t}();t.InlineRenderer=i})(t=e.Renderer||(e.Renderer={}))})(MarkdownIME||(MarkdownIME={}));var __extends=this&&this.__extends||function(e,t){for(var n in t)if(t.hasOwnProperty(n))e[n]=t[n];function r(){this.constructor=e}e.prototype=t===null?Object.create(t):(r.prototype=t.prototype,new r)};var MarkdownIME;(function(e){var t;(function(t){var n=function(){function t(){this.childNodeName=null;this.parentNodeName=null;this.isTypable=true;this.removeFeatureMark=true}t.prototype.Elevate=function(t){var n=this.prepareElevate(t);if(!n)return null;var r;var i;if(!this.childNodeName){r=t}else{r=t.ownerDocument.createElement(this.childNodeName);while(t.firstChild){r.appendChild(t.firstChild)}t.parentNode.insertBefore(r,t);t.parentElement.removeChild(t)}if(!this.parentNodeName){i=null}else{if(r.previousElementSibling&&r.previousElementSibling.nodeName==this.parentNodeName){i=r.previousElementSibling;i.appendChild(r)}else{i=r.ownerDocument.createElement(this.parentNodeName);e.Utils.wrap(i,r)}}return{child:r,parent:i,feature:n}};t.prototype.prepareElevate=function(e){if(!e)return null;var t=this.featureMark.exec(e.textContent);if(!t)return null;if(this.removeFeatureMark){var n=e;n.innerHTML=n.innerHTML.replace(/&nbsp;/g,String.fromCharCode(160)).replace(this.featureMark,"")}return t};return t}();t.BlockRendererContainer=n;var r;(function(e){var t=function(e){__extends(t,e);function t(){e.call(this);this.name="unordered list";this.featureMark=/^\s*[\*\+\-]\s+/;this.childNodeName="LI";this.parentNodeName="UL"}return t}(n);e.UL=t;var r=function(e){__extends(t,e);function t(){e.call(this);this.name="ordered list";this.featureMark=/^\s*(\d+)\.\s+/;this.childNodeName="LI";this.parentNodeName="OL"}t.prototype.Elevate=function(t){var n=e.prototype.Elevate.call(this,t);if(n){n.parent.setAttribute("start",n.feature[1])}return n};return t}(n);e.OL=r;var i=function(e){__extends(t,e);function t(){e.call(this);this.name="blockquote";this.featureMark=/^(\>|&gt;)\s*/;this.parentNodeName="BLOCKQUOTE"}return t}(n);e.BLOCKQUOTE=i;var o=function(e){__extends(t,e);function t(){e.call(this);this.isTypable=false;this.name="hr";this.featureMark=/^\s{0,2}([\-_\=\*])(\s*\1){2,}$/}t.prototype.Elevate=function(e){if(!this.prepareElevate(e))return null;var t=e.ownerDocument.createElement("hr");e.parentElement.insertBefore(t,e);e.parentElement.removeChild(e);return{parent:null,child:t}};return t}(n);e.HR=o;var a=function(e){__extends(t,e);function t(){e.call(this);this.name="code block";this.featureMark=/^```(\s*(\w+)\s*)?$/;this.removeFeatureMark=false}t.prototype.Elevate=function(e){var t=this.prepareElevate(e);if(!t)return null;var n=e.ownerDocument;var r=n.createElement("code");var i=n.createElement("pre");r.innerHTML='<br data-mdime-bogus="true">';i.appendChild(r);e.parentNode.insertBefore(i,e);e.parentElement.removeChild(e);if(t[1]){i.setAttribute("lang",t[2]);r.setAttribute("class",t[2])}return{parent:i,child:r}};return t}(n);e.CodeBlock=a;var s=function(e){__extends(t,e);function t(){e.call(this);this.name="header text";this.featureMark=/^(#+)\s+/}t.prototype.Elevate=function(e){var t=this.prepareElevate(e);if(!t)return null;var n=e.ownerDocument.createElement("H"+t[1].length);while(e.firstChild){n.appendChild(e.firstChild)}e.parentNode.insertBefore(n,e);e.parentElement.removeChild(e);return{parent:null,child:n}};return t}(n);e.HeaderText=s;var l=function(e){__extends(t,e);function t(){e.call(this);this.name="table header";this.featureMark=/^\|(.+)\|$/;this.removeFeatureMark=false}t.prototype.Elevate=function(e){var t=this.prepareElevate(e);if(!t)return null;var n=e.ownerDocument;var r=n.createElement("table");var i=n.createElement("tbody");var o=n.createElement("tr");var a=t[1].split("|").map(function(e){var t=n.createElement("th");t.textContent=e.trim();o.appendChild(t);return t});r.appendChild(i);i.appendChild(o);var s=e.parentElement;s.insertBefore(r,e);s.removeChild(e);var l=n.createElement(e.nodeName);l.innerHTML='<br data-mdime-bogus="true">';s.insertBefore(l,r.nextElementSibling);return{parent:r,child:a[0]}};return t}(n);e.TableHeader=l})(r=t.BlockRendererContainers||(t.BlockRendererContainers={}));var i=function(){function e(){this.containers=[]}e.prototype.Elevate=function(e){for(var t=0;t<this.containers.length;t++){var n=this.containers[t];var r=n.Elevate(e);if(r){r.containerType=n;return r}}return null};e.prototype.GetSuggestedNodeName=function(e){for(var t=0;t<this.containers.length;t++){var n=this.containers[t];if(n.parentNodeName==e.nodeName)return n.childNodeName}return null};e.prototype.AddMarkdownRules=function(){this.containers=e.markdownContainers.concat(this.containers);return this};e.markdownContainers=[new r.CodeBlock,new r.TableHeader,new r.BLOCKQUOTE,new r.HeaderText,new r.HR,new r.OL,new r.UL];return e}();t.BlockRenderer=i})(t=e.Renderer||(e.Renderer={}))})(MarkdownIME||(MarkdownIME={}));var MarkdownIME;(function(e){var t;(function(t){var n=function(){function t(){this.name="Emoji";this.use_shortcuts=true;this.use_twemoji=true;this.twemoji_config={};this.full_syntax=/:(\w+):/g;this.shortcuts_cache=[];this.chars={smile:"😄",smiley:"😃",grinning:"😀",blush:"😊",wink:"😉",heart_eyes:"😍",kissing_heart:"😘",kissing_closed_eyes:"😚",kissing:"😗",kissing_smiling_eyes:"😙",stuck_out_tongue_winking_eye:"😜",stuck_out_tongue_closed_eyes:"😝",stuck_out_tongue:"😛",flushed:"😳",grin:"😁",pensive:"😔",relieved:"😌",unamused:"😒",disappointed:"😞",persevere:"😣",cry:"😢",joy:"😂",sob:"😭",sleepy:"😪",disappointed_relieved:"😥",cold_sweat:"😰",sweat_smile:"😅",sweat:"😓",weary:"😩",tired_face:"😫",fearful:"😨",scream:"😱",angry:"😠",rage:"😡",confounded:"😖",laughing:"😆",satisfied:"😆",yum:"😋",mask:"😷",sunglasses:"😎",sleeping:"😴",dizzy_face:"😵",astonished:"😲",worried:"😟",frowning:"😦",anguished:"😧",imp:"👿",smiling_imp:"😈",open_mouth:"😮",neutral_face:"😐",confused:"😕",hushed:"😯",no_mouth:"😶",innocent:"😇",smirk:"😏",expressionless:"😑",smiley_cat:"😺",smile_cat:"😸",heart_eyes_cat:"😻",kissing_cat:"😽",smirk_cat:"😼",scream_cat:"🙀",crying_cat_face:"😿",joy_cat:"😹",pouting_cat:"😾",heart:"❤️",broken_heart:"💔",two_hearts:"💕",sparkles:"✨",fist:"✊",hand:"✋",raised_hand:"✋",cat:"🐱",mouse:"🐭",cow:"🐮",monkey_face:"🐵",star:"⭐",zap:"⚡",umbrella:"☔",hourglass:"⌛",watch:"⌚",black_joker:"🃏",mahjong:"🀄",coffee:"☕",anchor:"⚓",wheelchair:"♿",negative_squared_cross_mark:"❎",white_check_mark:"✅",loop:"➿",aries:"♈",taurus:"♉",gemini:"♊",cancer:"♋",leo:"♌",virgo:"♍",libra:"♎",scorpius:"♏",sagittarius:"♐",capricorn:"♑",aquarius:"♒",pisces:"♓",x:"❌",exclamation:"❗",heavy_exclamation_mark:"❗",question:"❓",grey_exclamation:"❕",grey_question:"❔",heavy_plus_sign:"➕",heavy_minus_sign:"➖",heavy_division_sign:"➗",curly_loop:"➰",black_medium_small_square:"◾",white_medium_small_square:"◽",black_circle:"⚫",white_circle:"⚪",white_large_square:"⬜",black_large_square:"⬛"};this.shortcuts={angry:[">:(",">:-("],blush:[':")',':-")'],broken_heart:["</3","<\\3"],confused:[":/",":-/"],cry:[":'(",":'-(",":,(",":,-("],frowning:[":(",":-("],heart:["<3"],two_hearts:[/(<3|❤){2}/g],imp:["]:(","]:-("],innocent:["o:)","O:)","o:-)","O:-)","0:)","0:-)"],joy:[":')",":'-)",":,)",":,-)",":'D",":'-D",":,D",":,-D"],kissing:[":*",":-*"],laughing:["x-)","X-)"],neutral_face:[":|",":-|"],open_mouth:[":o",":-o",":O",":-O"],rage:[":@",":-@"],smile:[":D",":-D"],smiley:[":)",":-)"],smiling_imp:["]:)","]:-)"],sob:[":,'(",":,'-(",";(",";-("],stuck_out_tongue:[":P",":-P"],sunglasses:["8-)","B-)"],sweat:[",:(",",:-("],sweat_smile:[",:)",",:-)"],unamused:[":s",":-S",":z",":-Z",":$",":-$"],wink:[";)",";-)"]}}t.prototype.render=function(e){e.replace(this.full_syntax,this.magic1.bind(this));if(this.use_shortcuts){if(!this.shortcuts_cache.length)this.UpdateShortcutCache();var t=this;for(var n=this.shortcuts_cache.length-1;n>=0;n--){e.replace(this.shortcuts_cache[n].regexp,function(){return t.magic1(null,t.shortcuts_cache[n].targetName)})}}};t.prototype.unrender=function(e){};t.prototype.magic1=function(e,t){var n=this.chars[t]||e;if(this.use_twemoji&&typeof twemoji!="undefined"){n=twemoji.parse(n,this.twemoji_config)}return n};t.prototype.UpdateShortcutCache=function(){this.shortcuts_cache=[];for(var t in this.shortcuts){var n=this.shortcuts[t];for(var r=n.length-1;r>=0;r--){var i=n[r];if(!(i instanceof RegExp)){i=new RegExp(e.Utils.text2regex(i),"g")}this.shortcuts_cache.push({regexp:i,length:i.toString().length,targetName:t})}}this.shortcuts_cache.sort(function(e,t){return e.length-t.length})};return t}();t.EmojiAddon=n})(t=e.Addon||(e.Addon={}))})(MarkdownIME||(MarkdownIME={}));var MarkdownIME;(function(e){var t;(function(t){var n;(function(e){e.codeblock=/^```\s*(\S*)\s*$/g})(n||(n={}));t.inlineRenderer=new t.InlineRenderer;t.blockRenderer=new t.BlockRenderer;t.inlineRenderer.AddMarkdownRules();t.inlineRenderer.AddRule(new e.Addon.EmojiAddon);t.blockRenderer.AddMarkdownRules();function r(n){var r=e.Utils.trim(n.innerHTML);var i;var o;var a=t.blockRenderer.Elevate(n);if(a){if(!a.containerType.isTypable)return a.child;n=a.child}t.inlineRenderer.RenderNode(n);return n}t.Render=r})(t=e.Renderer||(e.Renderer={}))})(MarkdownIME||(MarkdownIME={}));var MarkdownIME;(function(e){e.config={wrapper:"p"};var t=function(){function t(e){this.editor=e;this.document=e.ownerDocument;this.window=e.ownerDocument.defaultView;this.selection=this.window.getSelection();this.isTinyMCE=/tinymce/i.test(e.id)}t.prototype.Init=function(){if(!this.editor.hasAttribute("contenteditable"))return false;if(this.editor.hasAttribute("mdime-enhanced"))return false;this.editor.addEventListener("keydown",this.keydownHandler.bind(this),false);this.editor.addEventListener("keyup",this.keyupHandler.bind(this),false);this.editor.setAttribute("mdime-enhanced","true");return true};t.prototype.ProcessCurrentLine=function(t){var n;var r;var i=this.selection.getRangeAt(0);if(!i.collapsed)return;var o=i.startContainer;if(o.nodeType==Node.TEXT_NODE&&i.startOffset!=o.textContent.length){n=o;while(!e.Utils.is_node_block(n))n=n.parentNode;if(e.Utils.Pattern.NodeName.pre.test(n.nodeName)){o.parentNode.insertBefore(this.document.createTextNode(o.textContent.substr(i.startOffset)),o.nextSibling);n=this.document.createElement("br");o.parentNode.insertBefore(n,o.nextSibling);o.textContent=o.textContent.substr(0,i.startOffset);i.selectNode(n.nextSibling);i.collapse(true);this.selection.removeAllRanges();this.selection.addRange(i);t.preventDefault()}return}if(this.isTinyMCE){if(!e.Utils.Pattern.NodeName.pre.test(o.nodeName)&&!(o.childNodes.length==1&&o.firstChild.nodeName=="BR"))return;r=o;while(!e.Utils.is_node_block(r)){r=r.parentNode}if(e.Utils.Pattern.NodeName.pre.test(r.nodeName)){o=r;while(o.lastChild&&e.Utils.is_node_empty(o.lastChild)){o.removeChild(o.lastChild)}o.appendChild(this.document.createElement("br"));o.appendChild(this.document.createElement("br"));r=null}else if(e.Utils.Pattern.NodeName.cell.test(r.parentElement.nodeName)){o=r.parentElement;var a=r.previousSibling;var s;while(s=a.firstChild){o.insertBefore(s,a)}o.removeChild(a)}else{o=r.previousSibling;if(e.Utils.Pattern.NodeName.list.test(o.nodeName)){return}}}if(o==this.editor){o=this.document.createElement(e.config.wrapper||"div");o.innerHTML=this.editor.innerHTML;this.editor.innerHTML="";this.editor.appendChild(o)}while(!e.Utils.is_node_block(o)&&o.parentNode!=this.editor){o=o.parentNode}if(!e.Utils.is_node_block(o)&&o.parentNode==this.editor){n=this.document.createElement(e.config.wrapper||"div");e.Utils.wrap(n,o);o=n}var l=e.Utils.build_parent_list(o,this.editor);while(!e.Utils.is_node_block(o))o=l.shift();if(e.Utils.Pattern.NodeName.pre.test(o.nodeName)){var d=this.document.createTextNode("\n");if(!this.isTinyMCE){i.insertNode(d);var u=d.nextSibling;if(u&&u.nodeType===Node.TEXT_NODE&&u.textContent.length===0){d.parentNode.removeChild(u)}if(!d.nextSibling){d.parentNode.insertBefore(this.document.createElement("br"),d)}e.Utils.move_cursor_to_end(d);t.preventDefault()}var c=o.textContent;if(/^\n*(`{2,3})?\n*$/.test(c.substr(c.length-4))){var h=o.firstChild;var p;while(p=h.lastChild,p.nodeType===1&&p.nodeName==="BR"||p.nodeType===3&&/^\n*(```)?\n*$/.test(p.textContent))h.removeChild(p);this.CreateNewLine(o)}return}else if(e.Utils.is_line_empty(o)){var f=this.GenerateEmptyLine();if(e.Utils.Pattern.NodeName.list.test(o.parentNode.nodeName)){o.parentNode.removeChild(o);o=l.shift();if(e.Utils.Pattern.NodeName.list.test(o.parentNode.nodeName)){f=this.GenerateEmptyLine("li")}}else if(e.Utils.Pattern.NodeName.cell.test(o.nodeName)){var m=o.parentNode;var v=m.parentNode.parentNode;if(m.textContent.trim()===""){m.parentNode.removeChild(m);o=v}else{f=this.CreateNewCell(o);o=null}}else if(e.Utils.Pattern.NodeName.blockquote.test(o.parentNode.nodeName)){o.parentNode.removeChild(o);o=l.shift()}else{}o&&o.parentNode.insertBefore(f,o.nextSibling);e.Utils.move_cursor_to_end(f);t.preventDefault()}else{if(o.lastChild.attributes&&(o.lastChild.attributes.getNamedItem("data-mdime-bogus")||o.lastChild.attributes.getNamedItem("data-mce-bogus")))o.removeChild(o.lastChild);o=e.Renderer.Render(o);if(o.parentNode.nodeName==="PRE"){e.Utils.move_cursor_to_end(o);t.preventDefault()}else if(this.CreateNewLine(o)){t.preventDefault();r&&r.parentNode.removeChild(r)}else{e.Utils.move_cursor_to_end(r||o)}}};t.prototype.CreateNewCell=function(t){if(!t||!e.Utils.Pattern.NodeName.cell.test(t.nodeName))return null;var n;var r=t.parentNode;var i=r.parentNode.parentNode;var o=this.document.createElement("tr");for(var a=r.childNodes.length;a--;){if(e.Utils.Pattern.NodeName.cell.test(r.childNodes[a].nodeName)){var s=o.insertCell(0);s.innerHTML='<br data-mdime-bogus="true">';if(r.childNodes[a]===t){n=s}}}r.parentNode.insertBefore(o,r.nextSibling);return n};t.prototype.CreateNewLine=function(t){var n;var r=e.Utils.Pattern.NodeName;if(r.cell.test(t.nodeName)){n=this.CreateNewCell(t);e.Utils.move_cursor_to_end(n);return true}if(r.line.test(t.nodeName)||r.pre.test(t.nodeName)||r.hr.test(t.nodeName)){var i=r.li.test(t.nodeName)?"li":null;n=this.GenerateEmptyLine(i);t.parentNode.insertBefore(n,t.nextSibling);e.Utils.move_cursor_to_end(n);return true}return false};t.prototype.keydownHandler=function(t){var n=this.selection.getRangeAt(0);if(!n.collapsed)return;var r=t.keyCode||t.which;var i=!(t.shiftKey||t.ctrlKey||t.altKey);if(i&&r===13){this.ProcessCurrentLine(t);return}else if(r===9||r>=37&&r<=40){var o=false;var a=e.Utils.build_parent_list(n.startContainer,this.editor);a.unshift(n.startContainer);var s=a.filter(e.Utils.is_node_block);if(e.Utils.Pattern.NodeName.cell.test(s[0].nodeName)){var l=s[0];var d=l.parentElement;var u=d.parentElement.parentElement;var c=null;var h=0;while(h<d.childElementCount&&!d.children[h].isSameNode(l))h++;if(h<d.childElementCount){switch(r){case 9:if(i)c=l.nextElementSibling||d.nextElementSibling&&d.nextElementSibling.firstElementChild||this.CreateNewCell(d.firstElementChild);else if(t.shiftKey)c=l.previousElementSibling||d.previousElementSibling&&d.previousElementSibling.lastElementChild||u.previousElementSibling;break;case 38:if(i)c=d.previousElementSibling&&d.previousElementSibling.children[h]||u.previousElementSibling;break;case 40:if(i)c=d.nextElementSibling&&d.nextElementSibling.children[h]||u.nextElementSibling;break}if(c!==null){n.selectNodeContents(c.lastChild||c);n.collapse(false);this.selection.removeAllRanges();this.selection.addRange(n);o=true}}}if(o){t.preventDefault()}}};t.prototype.keyupHandler=function(t){var n=t.keyCode||t.which;var r=this.selection.getRangeAt(0);if(!r.collapsed)return;var i=r.startContainer;if(i.nodeType==Node.TEXT_NODE){var o=i.textContent;var a=o.substr(r.startOffset+1);var s=o.substr(0,r.startOffset);if(a.length)return;if(s.length<2)return;if(s.charAt(s.length-2)=="\\")return;if(n==32){var l=i.nextSibling;var d=true;while(!e.Utils.is_node_block(i)){if(d&&i!=i.parentNode.firstChild){d=false}i=i.parentNode}if(i!=this.editor&&i.nodeName!="PRE"){var u=d?e.Renderer.blockRenderer.Elevate(i):null;if(u==null){var c=e.Renderer.inlineRenderer.RenderNode(i);var h=l&&l.previousSibling||c.pop();e.Utils.move_cursor_to_end(h)}else{if(u.child.textContent.length==0)u.child.innerHTML='<br data-mdime-bogus="true">';e.Utils.move_cursor_to_end(u.child)}}}}};t.prototype.GenerateEmptyLine=function(t){if(t===void 0){t=null}var n;n=this.document.createElement(t||e.config.wrapper||"div");n.innerHTML='<br data-mdime-bogus="true">';return n};return t}();e.Editor=t})(MarkdownIME||(MarkdownIME={}));var MarkdownIME;(function(e){var t;(function(e){var t=function(){function e(e,t){this.disappearing=false;this.timeout=300;this.style="\nposition: absolute; \nfont-size: 10pt; \ncolor: #363; \nborder: 1px solid #363; \nbackground: #CFC; \npadding: 2pt 5pt; \nborder-radius: 0 0 5pt 0; \nz-index: 32760; \ntransition: .3s ease; \nopacity: 0; \n";this.element=e;this.timeout=t}e.prototype.show=function(){requestAnimationFrame(function(){var e=this.dismiss.bind(this);this.element.style.opacity="1";this.element.addEventListener("mousemove",e,false);if(this.timeout)setTimeout(e,this.timeout)}.bind(this))};e.prototype.dismiss=function(){if(this.disappearing)return;this.disappearing=true;this.element.style.opacity="0";setTimeout(function(){this.element.parentNode.removeChild(this.element)}.bind(this),300)};e.makeToast=function(t,n,r){if(r===void 0){r=0}var i=n.ownerDocument||n["createElement"]&&n||i;var o=n.parentNode||n["createElement"]&&n["body"];var a=i.createElement("div");var s=new e(a,r);a.setAttribute("style",s.style);a.textContent=t;a.style.left=(n.offsetLeft||0)+"px";a.style.top=(n.offsetTop||0)+"px";o.appendChild(a);return s};e.SHORT=800;e.LONG=2e3;return e}();e.Toast=t})(t=e.UI||(e.UI={}))})(MarkdownIME||(MarkdownIME={}));/*!@preserve
    [MarkdownIME](https://github.com/laobubu/MarkdownIME)
    
    Copyright 2016 laobubu

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
*/
var MarkdownIME;(function(e){function t(e){var n=e.document;var r;r=[].slice.call(n.querySelectorAll("[contenteditable]"));[].forEach.call(n.querySelectorAll("iframe"),function(e){var n=t(e.contentWindow);if(n.length)r=r.concat(n)});return r}e.Scan=t;function n(t){if(typeof t["length"]==="number"){return[].map.call(t,n)}var r;r=new e.Editor(t);if(r.Init())return r;return null}e.Enhance=n;function r(r){[].forEach.call(n(t(r)),function(t){e.UI.Toast.makeToast("MarkdownIME Activated",t.editor,e.UI.Toast.SHORT).show()})}e.Bookmarklet=r;e.bookmarklet=r;e.enhance=function(e,t){n(t)};e.prepare=e.enhance;e.scan=function(e){n(t(e))}})(MarkdownIME||(MarkdownIME={}));var MarkdownIME;(function(e){var t;(function(t){var n=function(){function t(){this.name="MathFormula";this.imgServer="http://latex.codecogs.com/gif.latex?";this.regex=/([^\\]|^)(\${1,2})(.*?[^\\])\2/g}t.prototype.render=function(t){var n=this;t.replace(this.regex,function(t,r,i,o){var a=e.Utils.text2html(o);var s=n.imgServer+encodeURIComponent(o);var l="<!--protect--><!--formula:"+a+'--><img alt="'+a+'" class="formula" src="'+s+'"><!--/protect-->';return r+l})};t.prototype.unrender=function(t){t.screwUp(/<!--protect--><!--formula:(.+?)--><img .+?><!--\/protect-->/g,function(t,n){return"$"+e.Utils.html_entity_decode(n)+"$"})};return t}();t.MathAddon=n})(t=e.Addon||(e.Addon={}))})(MarkdownIME||(MarkdownIME={}));